#!/bin/sh

# running on a TP-Link 4300

# stop after any errors
set -xe

uci import system <<EOF
EOF

uci add      system  system
uci set      system.@system[-1]=system
uci set      system.@system[-1].hostname='w16gw'
uci set      system.@system[-1].zonename='UTC'
uci set      system.@system[-1].timezone='UTC'
uci set      system.@system[-1].conloglevel='8'
uci set      system.@system[-1].klogconloglevel='8'
uci set      system.@system[-1].cronloglevel='0'
uci set      system.@system[-1].log_ip='10.7.11.1'
uci set      system.@system[-1].log_proto='tcp'
uci set      system.@system[-1].log_port='514'
uci set      system.@system[-1].log_size='128'
uci set      system.@system[-1].log_buffer_size='64'
uci set      system.@system[-1].log_remote='1'
uci set      system.ntp=timeserver
uci set      system.ntp.enabled=1
uci add_list system.ntp.server='0.de.pool.ntp.org'
uci add_list system.ntp.server='1.de.pool.ntp.org'
uci add_list system.ntp.server='2.de.pool.ntp.org'

uci add      system  led
uci set      system.@led[-1]=led
uci set      system.@led[-1].default='0'
uci set      system.@led[-1].dev='wg0'
uci set      system.@led[-1].mode='link tx rx'
uci set      system.@led[-1].name='vpn traffic'
uci set      system.@led[-1].sysfs='tp-link:blue:qss'
uci set      system.@led[-1].trigger='netdev'

uci add      system  led
uci set      system.@led[-1]=led
uci set      system.@led[-1].name='5ghz'
uci set      system.@led[-1].sysfs='tp-link:blue:wlan2g'
uci set      system.@led[-1].default='0'
uci set      system.@led[-1].trigger='netdev'
uci set      system.@led[-1].dev='wlan1'
uci set      system.@led[-1].mode='link tx rx'

uci add      system  led
uci set      system.@led[-1]=led
uci set      system.@led[-1].sysfs='ath9k-phy0'
uci set      system.@led[-1].default='0'
uci set      system.@led[-1].trigger='netdev'
uci set      system.@led[-1].dev='wlan0'
uci set      system.@led[-1].mode='link tx rx'

uci commit   system

uci import dropbear <<EOF
EOF

uci add    dropbear  dropbear
uci set    dropbear.@dropbear[-1]=dropbear
uci set    dropbear.@dropbear[-1].Port='22'
uci set    dropbear.@dropbear[-1].PasswordAuth='0'
uci set    dropbear.@dropbear[-1].RootPasswordAuth='0'
uci commit dropbear

cat <<'EOF' > /etc/dropbear/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCnAqd49QrBxYj73kAw+YKChDgc8KEOKhUqYtoP1pI9FPYV5tegMVtwhvPfovc6NoquzsViRzvFXsdw3Sp/aUCzOLknbthohBG+HtqxTICxVE76DtplwvoHnfF94wHC1Fl6OlvDkQRaCySgGhk7JWaVJAytaBMSZpPaAg+wlisCXpHAn36glpJv5Z9yHpK2XZ6NduYO7SqB0kYwKkLjBAjRjvQDhLdKtutVp00hHnefnTJlY8Q44UMqMomW/WL4XtjerttD59UCsPlnvtbKCWpOGAHLQlfpeqVnCpZp4eVpIRE7j/3E2CaNFc0qTK0mqnaH1Yk/6fQXQl1sgdYvq9Y8I8462irZrPuRrkgNAV6YKaUqven19nNLuybhq0cRG4K9lOZwTvvTyiMlRwo8uXawOwYoBAK+UiuCtoVvOo/+HkwCOFAU78LO8DyFGi3dLyZ6yy1jYSSuKOiSO2CuqHTszc0XE5E1bYWlua6hZoWa+agK4/zcvn6H+hy13xVOgcAMtjD4bVzYj2Wxqa4jSL0ye2m2FDE5LaEOyJLIYQ23hobrE2KvqRB/ALWLhvqJe5qUKDSWGkZvCyVArreaaLfUabcVZfdzmajt86suJJbfFQp9Dg5VHwIW6SssPL5NUNtHbfgoW7JCBXc64+nxmQqzHkcvBjahgEE+84/9zPKOqQ== router-keys@imaginator.com
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAADxTYX0f/RBMsEyObhp9xYFQ7cpMTaR+aEgXN+lGlbxEw/2wSTPWQ+NrO9SHUnPgRlQh8kwJKOJxvqjBclb48j/IDWPZNptfGsxtxU8jYsc0aTz3e4caLEaMsQM2L+TJJIkiH70Z77uDq1r/60PMKxk7oT8IOGtkIPr/yYn6X3amRBQM++WrMAkcxsbxCsOXr6wAUuxgVFSRSYU+RbnwYFvNmTEDANjNe53nhUZ5E3cRcrElVr9G4h2UjkgZVONDVxSfnGjTJkRs1e6cWILI/yvYJBolwuc+ddqfQbTZGc183YqiJAKAgKnpHsxeFfZGiwCPnzedewAbf0gOmZKanfF0Mzl00vcJJwsEGX/OM1e79MmfgXFqtbn0SCCEq7T1J03L2Ms5R+26aAh8rPb7QWRzZlg1v+W08hdmQqg/VIt8nMcyVey9zWpnKyJI9Q0Aq6xVSmFu9YKYyYw9/+2gJIAavOgd6eXP9UTOznvTHJYbtKzyYpOqbXmMp6+SSAtnyHJakPokRyIssa5AQOAB3ouQgyl7N1WebecAtStbs9qVS8A8kHjBmuLr7BN6lK/zgZQc2KAp4jL3txNChVeUxuzCPvkoCLiwJrtgWoy0Go/OWRserGXbxGwHmZ59FA4RG8HtbW4D1mkUbX5oPp3JPkNGhcuzYg+a1OZRvW3HINMhDkFCthyQqWp4AZXYDADHOjyTlVeZZ63NkuX7GX0UYZfn6H2x+sDKbGPCSWxndJkkclYJC+1xoXodcEdSn7CCjPDou33YeTa0hWesO07vh0kqGLW/NNTvzZ7YBMQdt/Snvf6p9Aw0dLHW754jsMXGczGt4LyEgy27i0r4MbqX4ahCvRjtefDA/HZx5dmd6lPiHcTMZZn3mXov05QFhofACqNjpse+rC8Xt/vRvTiBYotP3s2iX7Bqax3qv67Q16bLiy2Hg/xm26D3v5gXR1123oZSmZbv6KfCf5cqtTpMbtHWuFGaqnadbB9wzwki8P6PFOACsWGPEtReMNP9p17dO3j248jhptI7PHW65LsiRl3yuvM/8oP3sJvlJvDLpdzNcdGLdWYaQDx+YKKcu3lLVMwPthkHJmc8W1wbs9BxHiAQsibavRC7iggglNkflkZgQ4qLFY7JJpLAZ1+m6l0SdlikwuPIV9tc6i70MMw2AnVY7ubGMz27Y28lMY1OCM1Pze58abGIJ4EhC7JyUoxdhYc0yQYXFz3/YUHwZMvQve0Xos1xQrXqdhqtHAPfu82NeGM+rDR0iTiB/pQUxxIbs7q5Bkk36r
EOF
chmod 0600 /etc/dropbear/authorized_keys

uci import network <<EOF
EOF

#Port 	Switch port
#CPU 	0
#(WAN) 	1
#LAN 1 	2
#LAN 2 	3
#LAN 3 	4
#LAN 4 	5

uci add      network  switch
uci set      network.@switch[-1]=switch
uci set      network.@switch[-1].name='switch0'
uci set      network.@switch[-1].reset='1'
uci set      network.@switch[-1].enable_vlan='1'
uci commit   network.@switch[-1]

uci add      network  switch_vlan
uci set      network.@switch_vlan[-1]=switch_vlan
uci set      network.@switch_vlan[-1].device='switch0'
uci set      network.@switch_vlan[-1].vid='2'
uci set      network.@switch_vlan[-1].vlan='2'
uci set      network.@switch_vlan[-1].ports='0t 2t 3 4 5'
uci commit   network.@switch_vlan[-1]

uci add      network  switch_vlan
uci set      network.@switch_vlan[-1]=switch_vlan
uci set      network.@switch_vlan[-1].device='switch0'
uci set      network.@switch_vlan[-1].vid='4'
uci set      network.@switch_vlan[-1].vlan='4'
uci set      network.@switch_vlan[-1].ports='0t 1 2t'
uci commit   network.@switch_vlan[-1]

uci set      network.loopback=interface
uci set      network.loopback.ifname='lo'
uci set      network.loopback.proto='static'
uci set      network.loopback.ipaddr='127.0.0.1'
uci set      network.loopback.netmask='255.0.0.0'

uci set      network.lan=interface
uci set      network.lan.type='bridge'
#uci add_list network.lan.ip6class='henet'
uci add_list network.lan.ip6class='pyur6'
uci set      network.lan.ifname='eth0.2'
uci set      network.lan.igmp_snooping=1
uci set      network.lan.ip6assign='64'
uci set      network.lan.ipaddr='10.7.10.1'
uci set      network.lan.netmask='255.255.255.0'
uci set      network.lan.proto='static'

uci set      network.pyur4=interface
uci set      network.pyur4.ifname='eth0.4'
uci set      network.pyur4.proto='dhcp'
uci set      network.pyur4.broadcast=1
uci set      network.pyur4.peerdns=0
uci set      network.pyur4.defaultroute=1
#uci set      network.pyur4.ip4table='pyur4'

uci set      network.pyur6=interface
uci set      network.pyur6.ifname='eth0.4'
uci set      network.pyur6.proto='dhcpv6'
uci set      network.pyur6.reqaddress='try'
uci set      network.pyur6.reqprefix='auto'
uci set      network.pyur6.peerdns='0'
uci set      network.pyur6.metric='0'
#uci set      network.pyur6.ip6table='pyur6'

uci set      network.henet=interface
uci set      network.henet.proto='6in4'
uci set      network.henet.peeraddr='216.66.86.114'
uci set      network.henet.ip6addr='2001:470:6c:3f1::2/64'
uci set      network.henet.tunnelid='${henet_w16_tunnelid}'
uci set      network.henet.username='${henet_w16_username}'
uci set      network.henet.ip6prefix='2001:470:51cd::/48'
uci set      network.henet.password='${henet_w16_password}'
uci set      network.henet.metric='1'
uci set      network.henet.mtu='1480'


uci set      network.wg0='interface'
uci set      network.wg0.proto='wireguard'
uci set      network.wg0.mtu=1420
uci set      network.wg0.listen_port='12321'
uci add_list network.wg0.addresses='10.7.8.2/32'
uci set      network.wg0.private_key='${wg_w16gw_private_key}'

uci set      network.wgf17gw6=wireguard_wg0
uci set      network.wgf17gw6.description='F17 gateway (ipv6)'
uci set      network.wgf17gw6.public_key='${wg_f17gw_public_key}'
uci set      network.wgf17gw6.endpoint_host='f17gw6.imaginator.com'
uci set      network.wgf17gw6.endpoint_port='12321'
uci set      network.wgf17gw6.persistent_keepalive='15'
uci set      network.wgf17gw6.route_allowed_ips='1'
uci add_list network.wgf17gw6.allowed_ips='10.7.8.0/24'
uci add_list network.wgf17gw6.allowed_ips='10.7.9.0/24'
uci add_list network.wgf17gw6.allowed_ips='10.7.11.0/24'

uci set      network.wgf17gw4=wireguard_wg0
uci set      network.wgf17gw4.description='F17 gateway (ipv4)'
uci set      network.wgf17gw4.public_key='${wg_f17gw_public_key}'
uci set      network.wgf17gw4.endpoint_host='f17gw.imaginator.com'
uci set      network.wgf17gw4.endpoint_port='12321'
uci set      network.wgf17gw4.persistent_keepalive='15'
uci set      network.wgf17gw4.route_allowed_ips='1'
uci add_list network.wgf17gw4.allowed_ips='10.7.8.0/24'
uci add_list network.wgf17gw4.allowed_ips='10.7.9.0/24'
uci add_list network.wgf17gw4.allowed_ips='10.7.11.0/24'

# add routing tables

tables="/etc/iproute2/rt_tables"
test -d /etc/iproute2/ || mkdir -p /etc/iproute2/
grep -q "111 olsr" $tables || echo "111 olsr" >> $tables
grep -q "112 olsr-default" $tables || echo "112 olsr-default" >> $tables
grep -q "113 olsr-tunnel" $tables || echo "113 olsr-tunnel" >> $tables

#uci add      network  route
#uci set      network.@route[-1]=route
#uci set      network.@route[-1].table=100
#uci set      network.@route[-1].interface=eth0.4
#uci set      network.@route[-1].target=0.0.0.0
#uci set      network.@route[-1].netmask=0.0.0.0
#uci commit   network.@route[-1]

# how to reach each network on ffuplink
#uci add      network  rule
#uci set      network.@rule[-1]=rule
#uci set      network.@rule[-1].source='0.0.0.0/0'
#uci set      network.@rule[-1].lookup='111'
#uci set      network.@rule[-1].priority='90000'
#uci commit   network.@rule[-1]

uci commit network

uci import   wireless<<EOF
EOF

uci set wireless.radio0=wifi-device
uci set wireless.radio0.type='mac80211'
uci set wireless.radio0.hwmode='11g'
uci set wireless.radio0.path='platform/ar934x_wmac'
uci set wireless.radio0.htmode='HT20'
uci set wireless.radio0.country='DE'
uci set wireless.radio0.legacy_rates='0'
uci set wireless.radio0.log_level='0'
uci set wireless.radio0.disabled='0'
uci set wireless.radio0.channel='auto'

uci set wireless.radio1=wifi-device
uci set wireless.radio1.type='mac80211'
uci set wireless.radio1.hwmode='11a'
uci set wireless.radio1.path='pci0000:00/0000:00:00.0'
uci set wireless.radio1.htmode='HT40'
uci set wireless.radio1.country='DE'
uci set wireless.radio1.channel='40'
uci set wireless.radio1.legacy_rates='0'
uci set wireless.radio1.disabled='0'
uci set wireless.radio1.log_level='0'

uci add wireless  wifi-iface
uci set wireless.@wifi-iface[-1]=wifi-iface
uci set wireless.@wifi-iface[-1].device='radio0'
uci set wireless.@wifi-iface[-1].mode='ap'
uci set wireless.@wifi-iface[-1].ssid='imagiFi'
uci set wireless.@wifi-iface[-1].network='lan'
uci set wireless.@wifi-iface[-1].encryption='psk2'
uci set wireless.@wifi-iface[-1].key='${trusted_wifikey}'
uci set wireless.@wifi-iface[-1].disabled='1'

uci add wireless  wifi-iface
uci set wireless.@wifi-iface[-1]=wifi-iface
uci set wireless.@wifi-iface[-1].device='radio1'
uci set wireless.@wifi-iface[-1].mode='ap'
uci set wireless.@wifi-iface[-1].ssid='imagiFi 5'
uci set wireless.@wifi-iface[-1].macaddr='70:b8:c3:6e:fb:94'
uci set wireless.@wifi-iface[-1].network='lan'
uci set wireless.@wifi-iface[-1].encryption='psk2'
uci set wireless.@wifi-iface[-1].key='${trusted_wifikey}'
uci set wireless.@wifi-iface[-1].disabled='1'

uci commit wireless

uci import ddns <<EOF
EOF

uci add    ddns global
uci set    ddns.global=ddns
uci set    ddns.global.date_format='%F %R'
uci set    ddns.global.log_lines='250'
uci set    ddns.global.allow_local_ip='0'
uci commit ddns.global

uci add    ddns  service
uci set    ddns.@service[-1]=service
uci set    ddns.@service[-1].check_interval='5'
uci set    ddns.@service[-1].check_unit='minutes'
uci set    ddns.@service[-1].domain='${w16gw_ddns4_domain}'
uci set    ddns.@service[-1].enabled='1'
uci set    ddns.@service[-1].force_interval='5'
uci set    ddns.@service[-1].force_ipversion=1
uci set    ddns.@service[-1].force_unit='minutes'
uci set    ddns.@service[-1].interface='pyur4' # for hotplug events
uci set    ddns.@service[-1].ip_source='web'
uci set    ddns.@service[-1].ip_url='https://domains.google.com/checkip'
uci set    ddns.@service[-1].password='${w16gw_ddns4_password}'
uci set    ddns.@service[-1].retry_interval='1'
uci set    ddns.@service[-1].retry_unit='minutes'
uci set    ddns.@service[-1].service_name='google.com'
uci set    ddns.@service[-1].use_https='1'
uci set    ddns.@service[-1].use_ipv6='0'
uci set    ddns.@service[-1].use_logfile='0'
uci set    ddns.@service[-1].use_syslog='1'
uci set    ddns.@service[-1].username='${w16gw_ddns4_username}'
uci commit ddns.@service[-1]

uci add    ddns  service
uci set    ddns.@service[-1]=service
uci set    ddns.@service[-1].check_interval='5'
uci set    ddns.@service[-1].check_unit='minutes'
uci set    ddns.@service[-1].domain='${w16gw_ddns6_domain}'
uci set    ddns.@service[-1].enabled='1'
uci set    ddns.@service[-1].force_interval='5'
uci set    ddns.@service[-1].force_unit='minutes'
uci set    ddns.@service[-1].interface='henet' # for hotplug events
uci set    ddns.@service[-1].ip_network='henet'
uci set    ddns.@service[-1].ip_source='network'
uci set    ddns.@service[-1].password='${w16gw_ddns6_password}'
uci set    ddns.@service[-1].retry_interval='1'
uci set    ddns.@service[-1].retry_unit='minutes'
uci set    ddns.@service[-1].service_name='google.com'
uci set    ddns.@service[-1].use_https='1'
uci set    ddns.@service[-1].use_ipv6='1'
uci set    ddns.@service[-1].use_logfile='0'
uci set    ddns.@service[-1].use_syslog='1'
uci set    ddns.@service[-1].username='${w16gw_ddns6_username}'
uci commit ddns.@service[-1]

service ddns enable || true

uci import softflowd<<EOF
EOF

uci add    softflowd  softflowd
uci set    softflowd.@softflowd[-1]=softflowd
uci set    softflowd.@softflowd[-1].enabled='1'
uci set    softflowd.@softflowd[-1].interface='eth0.4'
uci set    softflowd.@softflowd[-1].timeout='maxlife=60'
uci set    softflowd.@softflowd[-1].max_flows='8192'
uci set    softflowd.@softflowd[-1].host_port='10.7.11.1:2055'
uci set    softflowd.@softflowd[-1].pid_file='/var/run/softflowd.pid'
uci set    softflowd.@softflowd[-1].control_socket='/var/run/softflowd.ctl'
uci set    softflowd.@softflowd[-1].export_version='9'
uci set    softflowd.@softflowd[-1].tracking_level='full'
uci set    softflowd.@softflowd[-1].track_ipv6='1'
uci set    softflowd.@softflowd[-1].sampling_rate='1'
uci commit softflowd.@softflowd[-1]

service softflowd enable || true

uci import prometheus-node-exporter-lua<<EOF
EOF

uci set    prometheus-node-exporter-lua.main=prometheus-node-exporter-lua
uci set    prometheus-node-exporter-lua.main.listen_interface='lan'
uci set    prometheus-node-exporter-lua.main.listen_port='9100'
uci commit prometheus-node-exporter-lua

service prometheus-node-exporter-lua enable || true

test -d /etc/adblock || mkdir -p /etc/adblock
cat <<'EOF' > /etc/adblock/adblock.blacklist
# domains to block
# the neighbour streams an inordinate amount of TV from here.
zattoo.de
zattoo.com
reddit.com
youtube.com
EOF

uci import adblock <<EOF
EOF

uci set    adblock.global=adblock
uci set    adblock.global.adb_backup='0'
uci set    adblock.global.adb_backupdir='/mnt'
uci set    adblock.global.adb_debug='1'
uci set    adblock.global.adb_dns='dnsmasq'
uci set    adblock.global.adb_enabled='1'
uci set    adblock.global.adb_forcedns='0'
uci set    adblock.global.adb_forcesrt='0'
uci set    adblock.global.adb_manmode='0'
uci set    adblock.global.adb_rtfile='/tmp/adb_runtime.json'
uci set    adblock.global.adb_trigger='pyur4'
uci set    adblock.global.adb_triggerdelay='5' # gives us the chance to log in and change this if using too much memory.
uci set    adblock.global.adb_whitelist='/etc/adblock/adblock.whitelist'
uci set    adblock.global.adb_whitelist_rset='\$1 ~/^([A-Za-z0-9_-]+\.){1,}[A-Za-z]+/{print tolower(\"^\"\$1\"\\\|[.]\"\$1)}'
uci commit adblock.global

uci add    adblock source
uci set    adblock.@source[-1]=source
uci rename adblock.@source[-1]=blacklist
uci set    adblock.@source[-1].enabled='1'
uci set    adblock.@source[-1].adb_src='/etc/adblock/adblock.blacklist'
uci set    adblock.@source[-1].adb_src_rset='\$1 ~/^([A-Za-z0-9_-]+\.){1,}[A-Za-z]+/{print tolower(\$1)}'
uci set    adblock.@source[-1].adb_src_desc='static local domain blacklist (always deny these domains)'
uci commit adblock.@source[-1]

uci add    adblock  source
uci set    adblock.@source[-1]=source
uci rename adblock.@source[-1]=adway
uci set    adblock.@source[-1].enabled='1'
uci set    adblock.@source[-1].adb_src='https://adaway.org/hosts.txt'
uci set    adblock.@source[-1].adb_src_rset='\$0 ~/^127\.0\.0\.1[ \t]+([A-Za-z0-9_-]+\.){1,}[A-Za-z]+/{print tolower(\$2)}'
uci set    adblock.@source[-1].adb_src_desc='focus on mobile ads, infrequent updates, approx. 400 entries'
uci commit adblock.@source[-1]

uci add    adblock  source
uci set    adblock.@source[-1]=source
uci rename adblock.@source[-1]=yoyo
uci set    adblock.@source[-1].enabled='1'
uci set    adblock.@source[-1].adb_src='https://pgl.yoyo.org/adservers/serverlist.php?hostformat=nohtml&showintro=0&mimetype=plaintext'
uci set    adblock.@source[-1].adb_src_rset='\$1 ~/^([A-Za-z0-9_-]+\.){1,}[A-Za-z]+/{print tolower(\$1)}'
uci set    adblock.@source[-1].adb_src_desc='focus on ad related domains, weekly updates, approx. 2.500 entries'
uci commit adblock.@source[-1]

uci add    adblock  source
uci set    adblock.@source[-1]=source
uci rename adblock.@source[-1]=malvertising
uci set    adblock.@source[-1].enabled='1'
uci set    adblock.@source[-1].adb_src='https://s3.amazonaws.com/lists.disconnect.me/simple_malvertising.txt'
uci set    adblock.@source[-1].adb_src_rset='\$1 ~/^([A-Za-z0-9_-]+\.){1,}[A-Za-z]+/{print tolower(\$1)}'
uci set    adblock.@source[-1].adb_src_desc='mozilla driven blocklist, numerous updates on the same day, approx. 6.500 entries'
uci commit adblock.@source[-1]

service adblock enable || true

uci import firewall <<EOF
EOF

uci add    firewall defaults 
uci set    firewall.@defaults[-1]=defaults
uci set    firewall.@defaults[-1].input='REJECT'
uci set    firewall.@defaults[-1].output='REJECT'
uci set    firewall.@defaults[-1].forward='REJECT'
uci set    firewall.@defaults[-1].flow_offloading=1
uci set    firewall.@defaults[-1].flow_offloading_hw=1
uci set    firewall.@defaults[-1].drop_invalid=1
uci commit firewall.@defaults[-1]

# A zone section groups one or more interfaces and serves as a source or destination for forwardings, 
# rules and redirects. Masquerading (NAT) of outgoing traffic is controlled on a per-zone basis. 
# Note that masquerading is defined on the outgoing interface.

# INPUT   rules for a zone describe what happens to traffic trying to reach the router itself through an interface in that zone.
# OUTPUT  rules for a zone describe what happens to traffic originating from the router itself going through an interface in that zone.
# FORWARD rules for a zone describe what happens to traffic passing between different interfaces in that zone.

uci add      firewall  zone
uci set      firewall.@zone[-1]=zone
uci set      firewall.@zone[-1].name='fflan'
uci add_list firewall.@zone[-1].network='fflan'
uci set      firewall.@zone[-1].input='ACCEPT'
uci set      firewall.@zone[-1].output='ACCEPT'
uci set      firewall.@zone[-1].forward='REJECT'
uci set      firewall.@zone[-1].log='1'
uci commit   firewall.@zone[-1]

uci add      firewall  zone
uci set      firewall.@zone[-1]=zone
uci set      firewall.@zone[-1].name='ffuplink'
uci add_list firewall.@zone[-1].network='ffuplink'
uci set      firewall.@zone[-1].device='tnl_+'
uci set      firewall.@zone[-1].input='REJECT'
uci set      firewall.@zone[-1].output='ACCEPT'
uci set      firewall.@zone[-1].forward='ACCEPT'
uci set      firewall.@zone[-1].log='1'
uci commit   firewall.@zone[-1]

uci add      firewall  zone
uci set      firewall.@zone[-1]=zone
uci set      firewall.@zone[-1].name='lan'
uci add_list firewall.@zone[-1].network='lan'
uci add_list firewall.@zone[-1].network='wg0'
uci set      firewall.@zone[-1].conntrack='1'
uci set      firewall.@zone[-1].log='1'
uci set      firewall.@zone[-1].mtu_fix='1'
uci set      firewall.@zone[-1].input='ACCEPT'
uci set      firewall.@zone[-1].output='ACCEPT'
uci set      firewall.@zone[-1].forward='REJECT'
uci commit   firewall.@zone[-1]

uci add      firewall  zone
uci set      firewall.@zone[-1]=zone
uci set      firewall.@zone[-1].name='wan'
uci add_list firewall.@zone[-1].network='pyur4'
uci add_list firewall.@zone[-1].network='pyur6'
uci add_list firewall.@zone[-1].network='henet'
uci set      firewall.@zone[-1].conntrack='1'
uci set      firewall.@zone[-1].forward='REJECT'
uci set      firewall.@zone[-1].input='REJECT'
uci set      firewall.@zone[-1].log='1'
uci set      firewall.@zone[-1].masq='1'
uci set      firewall.@zone[-1].mtu_fix='1'
uci set      firewall.@zone[-1].output='ACCEPT'
uci commit   firewall.@zone[-1]

uci add      firewall  forwarding
uci set      firewall.@forwarding[-1]=forwarding
uci set      firewall.@forwarding[-1].src='lan'
uci set      firewall.@forwarding[-1].dest='lan'
uci commit   firewall.@forwarding[-1]

uci add      firewall  forwarding
uci set      firewall.@forwarding[-1]=forwarding
uci set      firewall.@forwarding[-1].src='lan'
uci set      firewall.@forwarding[-1].dest='wan'
uci commit   firewall.@forwarding[-1]

uci add      firewall  forwarding
uci set      firewall.@forwarding[-1]=forwarding
uci set      firewall.@forwarding[-1].src='lan'
uci set      firewall.@forwarding[-1].dest='fflan'
uci commit   firewall.@forwarding[-1]

uci add      firewall  forwarding
uci set      firewall.@forwarding[-1]=forwarding
uci set      firewall.@forwarding[-1].src='fflan'
uci set      firewall.@forwarding[-1].dest='fflan'
uci commit   firewall.@forwarding[-1]

uci add      firewall  forwarding
uci set      firewall.@forwarding[-1]=forwarding
uci set      firewall.@forwarding[-1].src='fflan'
uci set      firewall.@forwarding[-1].dest='ffuplink'
uci commit   firewall.@forwarding[-1]

uci add      firewall  rule
uci set      firewall.@rule[0]=rule
uci set      firewall.@rule[0].name='Allow-DHCP-Renew'
uci set      firewall.@rule[0].src='wan'
uci set      firewall.@rule[0].proto='udp'
uci set      firewall.@rule[0].dest_port='68'
uci set      firewall.@rule[0].target='ACCEPT'
uci set      firewall.@rule[0].family='ipv4'
uci commit   firewall.@rule[0]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='Allow-Ping'
uci set      firewall.@rule[-1].src='*'
uci set      firewall.@rule[-1].proto='icmp'
uci set      firewall.@rule[-1].icmp_type='echo-request'
uci set      firewall.@rule[-1].family='ipv4'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='Allow-DHCPv6'
uci set      firewall.@rule[-1].src='wan'
uci set      firewall.@rule[-1].proto='udp'
uci set      firewall.@rule[-1].src_ip='fc00::/6'
uci set      firewall.@rule[-1].dest_ip='fc00::/6'
uci set      firewall.@rule[-1].dest_port='546'
uci set      firewall.@rule[-1].family='ipv6'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='Allow-MLD'
uci set      firewall.@rule[-1].src='wan'
uci set      firewall.@rule[-1].proto='icmp'
uci set      firewall.@rule[-1].src_ip='fe80::/10'
uci set      firewall.@rule[-1].icmp_type='130/0 131/0 132/0 143/0'
uci set      firewall.@rule[-1].family='ipv6'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='Allow-ICMPv6-Input'
uci set      firewall.@rule[-1].src='wan'
uci set      firewall.@rule[-1].proto='icmp'
uci set      firewall.@rule[-1].icmp_type='echo-request echo-reply destination-unreachable packet-too-big time-exceeded bad-header unknown-header-type router-solicitation neighbour-solicitation router-advertisement neighbour-advertisement'
uci set      firewall.@rule[-1].limit='1000/sec'
uci set      firewall.@rule[-1].family='ipv6'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='Allow-ICMPv6-Forward'
uci set      firewall.@rule[-1].src='wan'
uci set      firewall.@rule[-1].dest='*'
uci set      firewall.@rule[-1].proto='icmp'
uci set      firewall.@rule[-1].icmp_type='echo-request echo-reply destination-unreachable packet-too-big time-exceeded bad-header unknown-header-type'
uci set      firewall.@rule[-1].limit='1000/sec'
uci set      firewall.@rule[-1].family='ipv6'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='ssh'
uci set      firewall.@rule[-1].enabled='1'
uci set      firewall.@rule[-1].src='*'
uci set      firewall.@rule[-1].proto='tcp'
uci set      firewall.@rule[-1].dest_port='22'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='prometheus'
uci set      firewall.@rule[-1].enabled='1'
uci set      firewall.@rule[-1].src='lan'
uci set      firewall.@rule[-1].proto='tcp'
uci set      firewall.@rule[-1].dest_port='9100'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='freifunk DNS'
uci set      firewall.@rule[-1].enabled='1'
uci set      firewall.@rule[-1].src='fflan'
uci set      firewall.@rule[-1].proto='udp'
uci set      firewall.@rule[-1].proto='tcp'
uci set      firewall.@rule[-1].dest_port='53'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='olsr updates'
uci set      firewall.@rule[-1].enabled='1'
uci set      firewall.@rule[-1].src='ffuplink'
uci set      firewall.@rule[-1].proto='udp'
uci set      firewall.@rule[-1].dest_port='698'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

uci add      firewall  rule
uci set      firewall.@rule[-1]=rule
uci set      firewall.@rule[-1].name='wireguard'
uci set      firewall.@rule[-1].enabled='1'
uci set      firewall.@rule[-1].src='*'
uci set      firewall.@rule[-1].proto='udp'
uci set      firewall.@rule[-1].dest_port='12321'
uci set      firewall.@rule[-1].target='ACCEPT'
uci commit   firewall.@rule[-1]

/etc/init.d/firewall enable || true

uci import dhcp <<EOF
EOF

uci add      dhcp  dnsmasq
uci set      dhcp.@dnsmasq[-1]=dnsmasq
uci add_list dhcp.@dnsmasq[-1].rebind_domain='plex.direct'
uci add_list dhcp.@dnsmasq[-1].addnhosts='/tmp/hosts/olsr.ipv6'
uci add_list dhcp.@dnsmasq[-1].addnhosts='/tmp/hosts/olsr'
uci add_list dhcp.@dnsmasq[-1].rebind_domain='/imagilan/'
uci add_list dhcp.@dnsmasq[-1].server='1.0.0.1'
uci add_list dhcp.@dnsmasq[-1].server='1.1.1.1'
uci add_list dhcp.@dnsmasq[-1].server='2606:4700:4700::1001'
uci add_list dhcp.@dnsmasq[-1].server='2606:4700:4700::1111'
uci add_list dhcp.@dnsmasq[-1].server="/imagilan/10.7.11.5"
uci set      dhcp.@dnsmasq[-1].add_local_domain='1'
uci set      dhcp.@dnsmasq[-1].authoritative='1'
uci set      dhcp.@dnsmasq[-1].cachesize='4096'
uci set      dhcp.@dnsmasq[-1].domain='imagilan'
uci set      dhcp.@dnsmasq[-1].domainneeded='1'
uci set      dhcp.@dnsmasq[-1].expandhosts='1'
uci set      dhcp.@dnsmasq[-1].filterwin2k='1'
uci set      dhcp.@dnsmasq[-1].localise_queries='1'
uci set      dhcp.@dnsmasq[-1].localservice='1'
uci set      dhcp.@dnsmasq[-1].loglevel='7'
uci set      dhcp.@dnsmasq[-1].logqueries='0'
uci set      dhcp.@dnsmasq[-1].nonwildcard='1'
uci set      dhcp.@dnsmasq[-1].rebind_localhost='1'
uci commit   dhcp.@dnsmasq[-1]

uci set      dhcp.trusted=dhcp
uci set      dhcp.trusted.interface='lan'
uci add_list dhcp.trusted.domain='imagilan'
uci add_list dhcp.trusted.domain='imaginator.com'
uci set      dhcp.trusted.force='1'
uci set      dhcp.trusted.leasetime='24h'
uci set      dhcp.trusted.limit='100'
uci set      dhcp.trusted.start='100'
uci set      dhcp.trusted.ra='server'
uci add_list dhcp.trusted.dhcp_option='option:log-server, 10.7.11.1'
uci add_list dhcp.trusted.dhcp_option='option:ntp-server, 10.7.11.1'
uci commit   dhcp.trusted

uci set      dhcp.fflan=dhcp
uci set      dhcp.fflan.interface='fflan'
uci set      dhcp.fflan.domain='freifunk'
uci set      dhcp.fflan.force='1'
uci set      dhcp.fflan.leasetime='5m'
uci set      dhcp.fflan.limit='100'
uci set      dhcp.fflan.start='3'
uci add_list dhcp.fflan.dhcp_option='option:mtu, 1420'
uci add_list dhcp.fflan.dhcp_option='option:ntp-server, 10.7.11.1'
uci add_list dhcp.fflan.dhcp_option='3,10.36.189.1'
uci commit   dhcp.fflan


#AP Pro
uci add      dhcp host
uci set      dhcp.@host[-1]=host
uci set      dhcp.@host[-1].ip='10.7.10.2'
uci set      dhcp.@host[-1].name='repeater06'
uci set      dhcp.@host[-1].mac='dc:9f:db:1a:ce:8e'
uci set      dhcp.@host[-1].dns='1'
uci commit   dhcp.@host[-1]

uci add      dhcp  host
uci set      dhcp.@host[-1]=host
uci set      dhcp.@host[-1].ip='10.7.10.3'
uci set      dhcp.@host[-1].name='hue'
uci set      dhcp.@host[-1].mac='00:17:88:23:8a:64'
uci set      dhcp.@host[-1].dns='1'
uci commit   dhcp.@host[-1]

uci add      dhcp  host
uci set      dhcp.@host[-1]=host
uci set      dhcp.@host[-1].ip='10.7.10.4'
uci set      dhcp.@host[-1].name='homematic'
uci set      dhcp.@host[-1].mac='00:1a:22:07:e0:96'
uci set      dhcp.@host[-1].dns='1'
uci commit   dhcp.@host[-1]

echo -e "All done with writing.\nRebooting..."
reboot